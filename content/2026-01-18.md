---
title: "2026-01-18_搭建反向 vpn 使用 g 的 api"
date: 2026-01-18
tags: 
  - gemini加速
  - ai 学习
---
每次使用 gemini 都需要加载半天网页，这消耗了我不少时间。打算尝试一下 api 的方式使用 gemini。搞了 2 个半小时，作为非程序员的我也搞定了。

-----

# 第一部分：利用 Cloudflare Workers 搭建零成本、直连的 Google Gemini API 代理

在开发 AI 应用或使用 Obsidian 插件时，直接调用 Google Gemini API 面临着两个主要痛点：一是 **GFW 的网络阻断**，二是 **频繁开启 VPN 带来的工作流割裂与高延迟**。

本文将介绍一种基于 **Cloudflare Workers** 的 Serverless 解决方案。通过搭建反向代理，我们可以实现**国内直连**、**低延迟**且**完全免费**的 Gemini API 调用体验。

## 原理简述

传统的 VPN 方案是建立一条加密隧道，所有流量绕地球一圈。而反向代理（Reverse Proxy）方案则是利用 Cloudflare 在全球（包括其与 Google 的对等连接）的边缘节点作为“中转站”。

请求链路：

本地客户端 -> 自定义域名 (Cloudflare CDN) -> Worker 脚本 -> Google Gemini API

由于 Cloudflare 的边缘节点在 Google 的“白名单”内，且 Cloudflare 的 IP 在国内通常可访问，因此实现了“曲线救国”。

## 准备工作

1. **Google API Key:** 前往 [Google AI Studio](https://aistudio.google.com/) 免费获取。
    
2. **Cloudflare 账号:** 免费版即可。
    
3. **一个域名:** 建议购买冷门后缀（如 `.xyz` 或 `.top`），首年成本仅需 $1 左右（推荐在 Namesilo 或 Namecheap 购买，需支持修改 Nameservers）。
    

---

## 搭建步骤

### 第一步：域名托管迁移 (NS 接入)

为了使用 Cloudflare 的 Workers 功能，我们需要将域名的 DNS 解析权移交给 Cloudflare。

1. 在域名注册商（如 Namesilo）后台，找到 **Nameservers** 设置。
    
2. 在 Cloudflare 添加你的域名，它会提供两个服务器地址（例如 `xxx.ns.cloudflare.com`）。
    
3. 将注册商默认的 NS 记录**全部删除**，替换为 Cloudflare 提供的这两个地址。
    
4. 等待生效（通常 10-20 分钟）。当 Cloudflare 后台显示域名状态为 **Active** 时，即可进行下一步。
    

### 第二步：部署 Worker 脚本

这是核心环节。我们需要一段轻量级的 JavaScript 代码来转发请求。

1. 登录 Cloudflare Dashboard，进入 **Compute (Workers & Pages)**。
    
2. 点击 **Create Worker** -> **Deploy** (先部署一个空的 Hello World)。
    
3. 点击 **Edit code**，将原有代码清空，粘贴以下代码：
    

JavaScript

```
export default {
  async fetch(request, env, ctx) {
    // 1. 获取原始请求的 URL
    const url = new URL(request.url);

    // 2. 将目标主机名修改为 Google Gemini 的官方 API 地址
    // 所有的 Path 和参数都会自动保留
    url.hostname = 'generativelanguage.googleapis.com';

    // 3. 构建新请求，保留原始 Header (包含 API Key) 和 Body
    const newRequest = new Request(url, request);

    // 4. 发送请求给 Google，并将响应原封不动地返回给客户端
    return fetch(newRequest);
  },
};
```

4. 点击右上角的 **Deploy** 保存。
    

### 第三步：绑定自定义域名 (Custom Domain)

默认的 `*.workers.dev` 域名在国内无法访问，因此必须绑定我们自己的域名。

1. 在刚才创建的 Worker 页面，点击 **Settings** -> **Triggers**。
    
2. 点击 **Add Custom Domain**。
    
3. 输入一个二级域名，例如：`gemini.your-domain.xyz`。
    
4. 点击添加。等待状态变为 **Active**，SSL 证书会自动颁发。
    

---

## 验证与使用

配置完成后，**无需开启 VPN**，直接在终端测试：

Bash

```
# 请将 <YOUR_API_KEY> 替换为你的真实 Key
curl "https://gemini.your-domain.xyz/v1beta/models?key=<YOUR_API_KEY>"
```

如果返回了包含模型列表（如 `gemini-2.5-flash`）的 JSON 数据，说明链路已打通。

### 场景一：Python 开发

使用 `requests` 库时，只需替换 `base_url`：

Python

```
import requests

# 使用你的自定义域名
base_url = "https://gemini.your-domain.xyz/v1beta/models/gemini-2.5-flash:generateContent"
api_key = "YOUR_GOOGLE_API_KEY"

url = f"{base_url}?key={api_key}"
payload = {
    "contents": [{"parts": [{"text": "Hello, Gemini!"}]}]
}

# 直连请求，速度极快
response = requests.post(url, json=payload)
print(response.json())
```

### 场景二：Obsidian / VS Code 插件配置

在各类支持自定义 API 的工具（如 Obsidian Text Generator, Chatbox, Cursor 等）中，配置逻辑如下：

- **API Provider:** 选择 Google Gemini 或 OpenAI Compatible。
    
- **API Key:** 填入你的 Google Key。
    
- **Base URL / Endpoint:** 填入 `https://gemini.your-domain.xyz/v1beta`
    
    - _注：部分软件可能不需要 `/v1beta` 后缀，视具体实现而定。_
        
- **Model:** 推荐使用 `gemini-2.5-flash`（速度快、上下文长）或 `gemini-2.5-pro`（逻辑强）。
    

---

## 第一部分总结

通过这个方案，我们以不到一杯咖啡的年度成本（域名费），获得了一个**高可用、低延迟、不依赖本地代理环境**的私人 Gemini 接口。这对于追求极致效率的开发者来说，绝对是目前性价比最高的选择。

**安全提示：** 请务必保管好你的 API Key，不要将包含 Key 的代码上传到公开仓库。


---

# 第二部分：进阶配置与多端全流程部署

## 1. 核心设施：Cloudflare Worker 终极版

**更新目的**：解决流式输出卡顿、跨域 (CORS) 报错，并**强制关闭** Google 的安全过滤（防止正常内容被误杀）。

**Worker 代码 (v2.0)**：

> ⚠️ **关键修正**：安全设置必须使用完整的枚举名称（如 `HARM_CATEGORY_HATE_SPEECH`），否则 API 会报错 400。

JavaScript

```
export default {
  async fetch(request, env, ctx) {
    // 1. 处理 CORS 预检 (解决前端跨域问题)
    if (request.method === "OPTIONS") {
      return new Response(null, {
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
          "Access-Control-Allow-Headers": "*",
        },
      });
    }

    const url = new URL(request.url);
    url.hostname = 'generativelanguage.googleapis.com';

    let newBody = request.body;

    // 2. 注入安全过滤规则 (仅针对 POST 请求)
    // 强制将所有安全阈值设为 BLOCK_NONE，移除 API 网关拦截
    if (request.method === "POST") {
      try {
        const bodyJson = await request.json();
        bodyJson.safetySettings = [
          { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_CIVIC_INTEGRITY", threshold: "BLOCK_NONE" }
        ];
        newBody = JSON.stringify(bodyJson);
      } catch (e) {
        newBody = request.body; // 解析失败则保持原样
      }
    }

    // 3. 构造新请求
    const newRequest = new Request(url, {
      method: request.method,
      headers: request.headers,
      body: newBody
    });

    const response = await fetch(newRequest);

    // 4. 返回带 CORS 头的响应 (清洗 Header，确保流式透传)
    const newResponse = new Response(response.body, response);
    newResponse.headers.set("Access-Control-Allow-Origin", "*");
    newResponse.headers.set("Access-Control-Allow-Headers", "*");

    return newResponse;
  },
};
```

---

## 2. 全平台客户端配置清单

### 💻 生产力场景：Obsidian (Copilot 插件)

- **Provider**: `OpenAI Compatible` (必须选此项以支持自定义 URL)
    
- **Base URL**: `https://gemini.你的域名.xyz/v1beta/openai`
    
- **API Key**: 你的 Google AI Studio Key
    
- **核心模型**:
    
    - `gemini-3-pro-preview` (逻辑推理/笔记分析 - 推荐温度 **0.1**)
        
    - `gemini-3-flash-preview` (快速对话/头脑风暴 - 推荐温度 **1.0**)
        
- **功能开关**: ✅ Stream (开启) | ❌ Web Search (关闭)
    

### 🖥️ 桌面主力：Cherry Studio

- **Provider**: `Google Gemini` (原生模式)
    
- **API URL**: `https://gemini.你的域名.xyz` (无需后缀)
    
- **优势**: 完美支持原生识图 (Vision)、本地历史记录存储、无频率限制。
    

### 📱 移动端/Web：NextChat (Cloudflare Pages) 这个需要梯子，仍然不够友好 

- **架构**: Fork 仓库 -> CF Pages 部署 -> 绑定自定义域名 (`chat.你的域名.xyz`)。
    
- **安全**: 在 Pages 环境变量中设置 `CODE` = `你的访问密码`。
    
- **使用**: 手机浏览器打开 -> 添加到主屏幕 (PWA)。
    
- **配置**: 接口地址填 `https://gemini.你的域名.xyz`。
    

---

## 3. 运维与故障排查

### 🛡️ 关于安全过滤 (Safety Settings)

- **生效范围**: Worker 代码移除了 API 网关层的“关键词拦截”（第一道门）。
    
- **实际效果**: 医学描述、文学创作中的灰色内容不再被误杀。
    
- **局限性**: 无法移除模型内生对齐（RLHF）。极端恶意请求（如造炸弹）仍会被模型礼貌拒绝，这是正常的。
    

### 🌐 Quartz 发布排除 (防止脏数据)

Copilot 插件会生成包含索引和历史记录的文件夹，需在发布时排除。

1. 主要**修改 `quartz.config.ts`**:
    
    TypeScript
    
    ```
    ignorePatterns: [".obsidian", "templates", "copilot"]
    ```
    
2. ~~**修改 `.gitignore`**:~~
    
    ~~Plaintext~~
    
    ```
    content/copilot/
    ```
    

### 📦 Obsidian 多库迁移

- **问题**: 新建 Vault 后 Copilot 配置丢失。
    
- ~~**解决**: 复制旧库的 `.obsidian/plugins/copilot-obsidian-plugin/data.json` 到新库对应位置，重启插件即可恢复 Key 和 URL 设置。~~
    重新配置 copilot 的模型是最快的方法

---

## 4. 最终决策：取消订阅

> **结论：建议取消 $20/月的 Google One AI Premium 订阅。**

**对比分析**： | 维度 | API 自建方案 (当前) | 官方网页版 (订阅) | | :--- | :--- | :--- | | **成本** | **≈ $0** (Flash 免费/Pro 极低) | **$240 / 年** | | **网络** | **国内直连** (无需 VPN) | 必须 VPN (且易被封锁) | | **隐私** | **本地存储** (不训练数据) | 云端存储 (可能训练) | | **能力** | 上下文一致 (2M Token) | 上下文一致 | | **短板** | 无原生 Google 搜索 | **支持实时联网搜索** |

**替代方案**：使用 Perplexity (免费版) 弥补实时联网搜索需求，其余生产力场景 API 完胜。